<div align="center">
  
# 服务器API6

</div>

## 说明

- 使用Socket与服务器进行通信
- 为防止恶意攻击，只允许**认证**的客户端携带**令牌**使用[激活战备](#激活战备)、[激活按键](#激活按键)、[发送配置](#发送配置)、[获取配置](#获取配置)接口
  - 使用[获取令牌](#获取令牌)接口以获取认证和令牌
  - 令牌仅**当前连接有效**，再次连接时需**重新获取**
  - 服务器关闭认证功能后，客户端仍需要进行完整的认证流程，服务器将自动通过所有认证请求
- 使用此版本API的服务器可向下兼容至[API5(0.5.x)](./server_api_5.md)

## 接口

### 获取服务器状态

客户端发送：

```json
{
    "opt": 0,
    "api": 6    // 客户端API版本
}
```

服务器返回：

```json
{
    "status": 0,// 服务器状态
    // 0 就绪
    // 1 客户端版本不符
    // 2 客户端未认证 
    "api": 6    // 服务器版本
}
```

说明

- 若客户端未被认证，请参考[获取令牌](#获取令牌)接口
- 可使用此接口实现心跳机制

### 获取令牌

客户端发送：

```json
{
    "opt": 5,
    "sid": "xxx"    // 客户端标识
}
```

服务器返回：

```json
// 认证成功
{
    "auth": true,
    "token": "xxx"  // 令牌
}

// 认证失败
{
    "auth": false
}
```

说明

- `客户端标识`应在第一次启动客户端时随机生成，确保每台设备标识不同
- 此接口可能需要用户参与，请确保连接不会因此超时
- 认证有效期内使用此接口即可获取令牌
- 令牌仅**当前连接**有效，再次连接时需**重新获取**
- 服务器关闭认证功能后，该接口将会立即返回认证成功

### 激活战备

客户端发送：

```json
{
    "opt": 1,
    "token": "xxx",         // 令牌
    "macro": {              // 战备信息
        "name": "xxx",      // 战备显示名称
        "steps": [1, 4, 4], // 按键
        // 1 上
        // 2 下
        // 3 左
        // 4 右
    }
}
```

### 激活按键

客户端发送：

```json
{
    "opt": 2,
    "token": "xxx",     // 令牌
    "input": {          // 按键信息
        "type": 0,  // 类型
        // 0 点击
        // 1 按下
        // 2 释放
        // 3 开始（仅用于标识自由输入功能开启）
        // 4 结束（仅用于标识自由输入功能关闭）
        "step": 0,      // 按键
        // 0 打开战略配备列表
        // 1 上
        // 2 下
        // 3 左
        // 4 右
    }
}
```

### 发送配置

客户端发送：

```json
{
    "opt": 4,
    "token": "xxx",             // 令牌
    "config": {                 // 配置信息
        "server": {
            "port": 23333,      // 服务器监听端口
            "ip": ""            // 服务器监听地址，留空则自动获取
        },
        "input": {
            "delay": 25,        // 按键延迟（毫秒）
            "open": "ctrl_left",// 按键：打开战略配备列表
            "keytype": "hold",  // 按键类型：打开战略配备列表
            "up": "w",          // 按键：上
            "down": "s",        // 按键：下
            "left": "a",        // 按键：左
            "right": "d"        // 按键：右
        },
        "auth": {
            "enabled": true,    // 启用认证功能
            "timeout": 3,       // 认证有效期（天）
        },
        "debug": false,         // 启用服务器调试模式
        "records": []           // 保留字段，不可删除
    }
}
```

说明

- 请完整发送`配置信息`（即使您只想修改其中几项项），否则服务器将无法解析
- `按键`参数请查阅[按键值](#按键值)
- `按键类型`参数请查阅[按键类型值](#按键类型值)

### 获取配置

客户端发送：

```json
{
    "opt": 3,
    "token": "xxx"      // 令牌
}
```

服务器返回：

```json
// 客户端未认证
无返回

// 客户端已认证
{
     "server": {
        "port": 23333,      // 服务器监听端口
        "ip": ""            // 服务器监听地址，留空则自动获取
    },
    "input": {
        "delay": 25,        // 按键延迟（毫秒）
        "open": "ctrl_left",// 按键：打开战略配备列表
        "keytype": "hold",  // 按键类型：打开战略配备列表
        "up": "w",          // 按键：上
        "down": "s",        // 按键：下
        "left": "a",        // 按键：左
        "right": "d"        // 按键：右
    },
    "auth": {
        "enabled": true,    // 启用认证功能
        "timeout": 3,       // 认证有效期（天）
    },
    "debug": false,         // 启用服务器调试模式
    "records": []           // 保留字段，不可删除
}
```

说明

- 客户端未认证时将不会有任何返回
- `按键`参数请查阅[按键值](#按键值)
- `按键类型`参数请查阅[按键类型值](#按键类型值)

## 附录

### 按键值

| 值 | 说明 |
| --- | --- |
| alt | 左Alt |
| alt_gr | 右Alt |
| ctrl_left | 左Ctrl |
| ctrl_right | 右Ctrl |
| shift_left | 左Shift |
| shift_right | 右Shift |
| up | 上箭头 |
| down | 下箭头 |
| left | 左箭头 |
| right | 右箭头 |
| 1 |  |
| 2 |  |
| 3 |  |
| 4 |  |
| 5 |  |
| 6 |  |
| 7 |  |
| 8 |  |
| 9 |  |
| 0 |  |
| a |  |
| b |  |
| c |  |
| d |  |
| e |  |
| f |  |
| g |  |
| h |  |
| i |  |
| j |  |
| k |  |
| l |  |
| m |  |
| n |  |
| o |  |
| p |  |
| q |  |
| r |  |
| s |  |
| t |  |
| u |  |
| v |  |
| w |  |
| x |  |
| y |  |
| z |  |
| ` |  |
| - |  |
| = |  |
| ; |  |
| \' |  |
| \\ |  |
| , |  |
| . |  |
| / |  |
| f1 |  |
| f2 |  |
| f3 |  |
| f4 |  |
| f5 |  |
| f6 |  |
| f7 |  |
| f8 |  |
| f9 |  |
| f10 |  |
| f11 |  |
| f12 |  |
| backspace |  |
| enter |  |
| delete |  |
| caps_lock |  |
| space |  |
| tab |  |
| fn |  |
| insert |  |
| home |  |
| end |  |
| esc |  |
| page_down |  |
| page_up |  |
| print_screen |  |
| scroll_lock |  |
| num_lock |  |
| pause |  |
| kp- | 小键盘 - |
| kp+ | 小键盘 + |
| kp* | 小键盘 * |
| kp/ | 小键盘 / |
| kp0 | 小键盘 0 |
| kp1 | 小键盘 1 |
| kp2 | 小键盘 2 |
| kp3 | 小键盘 3 |
| kp4 | 小键盘 4 |
| kp5 | 小键盘 5 |
| kp6 | 小键盘 6 |
| kp7 | 小键盘 7 |
| kp8 | 小键盘 8 |
| kp9 | 小键盘 9 |
| kp_delete | 小键盘 Delete |
| mouse_left | 鼠标左键 |
| mouse_right | 鼠标右键 |
| mouse_middle | 鼠标中键 |
| mouse3 | 鼠标侧键 1 |
| mouse4 | 鼠标侧键 2 |
| mouse5 | 鼠标侧键 3 |
| wheel_up | 鼠标滚轮 上 |
| wheel_down | 鼠标滚轮 下 |

### 按键类型值

| 值 | 说明 |
| --- | --- |
| hold | 按住 |
| press | 按下 |
| long_press | 长按 |
| tap | 轻按 |
| double_tap | 连按两次 |

## 与[API5(0.5.x)](./server_api_5.md)的差异

- [获取服务器状态](#获取服务器状态)
  - 删除ver字段
  - 加入api字段，标识客户端/服务器API版本
- [获取令牌](#获取令牌)
  - 服务器关闭认证功能后，该接口将会立即返回认证成功
- [获取配置](#获取配置)和[发送配置](#发送配置)
  - 大幅修改以传递更多的配置信息
- 服务器关闭认证功能后，客户端仍需要进行完整的认证流程，服务器将自动通过所有认证请求